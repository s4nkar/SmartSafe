{% extends "base.html" %}

{% block title %}Biometric Setup - Smart Attendance{% endblock %}

{% block content %}
<div class="row justify-content-center mt-5 mb-5">
    <div class="col-md-10 text-center">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h4>Step 2: Biometric Enrollment</h4>
            </div>
            <div class="card-body">
                <p class="text-muted">We need both your face and voice to secure your account.</p>

                <div class="row">
                    <!-- Face Section -->
                    <div class="col-md-6 border-end">
                        <h5>1. Face Scan</h5>
                        <div class="position-relative d-inline-block mt-2">
                            <video id="video" width="100%" height="auto" autoplay muted
                                style="border-radius: 10px; border: 2px solid #ddd; max-width: 400px;"></video>
                            <canvas id="canvas" style="display:none;"></canvas>
                        </div>
                        <p class="small text-muted mt-2">Align your face in the center.</p>
                    </div>

                    <!-- Voice Section -->
                    <div class="col-md-6">
                        <h5>2. Voice Sample</h5>
                        <div class="mt-4">
                            <i class="bi bi-mic-fill text-primary" style="font-size: 4rem;"></i>
                            <p class="mt-3">Please say: <b class="text-dark fs-5">"Blue Sky"</b></p>

                            <button id="record-btn" class="btn btn-outline-primary mb-3">
                                <i class="bi bi-record-circle"></i> Hold to Record
                            </button>
                            <br>
                            <audio id="audio-preview" controls class="d-none w-100"></audio>
                            <p id="audio-status" class="small text-muted">No audio recorded yet.</p>
                        </div>
                    </div>
                </div>

                <hr>

                <div class="mt-3">
                    <p id="status-msg" class="text-info fw-bold">Waiting for inputs...</p>
                    <button id="submit-btn" class="btn btn-lg btn-success px-5" disabled>
                        <i class="bi bi-check-lg"></i> Complete Registration
                    </button>
                    <div id="loading" class="spinner-border text-primary" role="status" style="display:none;">
                        <span class="visually-hidden">Processing...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const submitBtn = document.getElementById('submit-btn');
    const recordBtn = document.getElementById('record-btn');
    const audioPreview = document.getElementById('audio-preview');
    const audioStatus = document.getElementById('audio-status');
    const statusMsg = document.getElementById('status-msg');
    const loading = document.getElementById('loading');

    let faceBlob = null; // We will use base64 for simplicity with the existing backend
    let audioBlob = null;
    let audioBase64 = null;
    let mediaRecorder;
    let audioChunks = [];

    // 1. Access Camera
    navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
            video.srcObject = stream;
        })
        .catch(err => console.error("Camera Error:", err));

    // 2. Access Microphone for Recording
    navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
            mediaRecorder = new MediaRecorder(stream);

            mediaRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = () => {
                audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                const audioUrl = URL.createObjectURL(audioBlob);
                audioPreview.src = audioUrl;
                audioPreview.classList.remove('d-none');
                audioStatus.innerText = "Audio recorded!";
                statusMsg.innerText = "Audio captured. Click Complete to finish.";
                checkReadiness();

                // Convert to Base64
                const reader = new FileReader();
                reader.readAsDataURL(audioBlob);
                reader.onloadend = () => {
                    audioBase64 = reader.result;
                }
            };
        })
        .catch(err => console.error("Mic Error:", err));

    // Recording Logic (Hold to Record)
    recordBtn.addEventListener('mousedown', () => {
        audioChunks = [];
        if (mediaRecorder && mediaRecorder.state === "inactive") {
            mediaRecorder.start();
            recordBtn.innerHTML = '<i class="bi bi-mic-fill"></i> Recording...';
            recordBtn.classList.add('active');
        }
    });

    recordBtn.addEventListener('mouseup', () => {
        if (mediaRecorder && mediaRecorder.state === "recording") {
            mediaRecorder.stop();
            recordBtn.innerHTML = '<i class="bi bi-record-circle"></i> Hold to Record';
            recordBtn.classList.remove('active');
        }
    });
    // Touch support for mobile
    recordBtn.addEventListener('touchstart', (e) => { e.preventDefault(); recordBtn.dispatchEvent(new Event('mousedown')); });
    recordBtn.addEventListener('touchend', (e) => { e.preventDefault(); recordBtn.dispatchEvent(new Event('mouseup')); });


    function checkReadiness() {
        if (audioBlob) {
            submitBtn.disabled = false;
        }
    }

    // 3. Submit All
    submitBtn.addEventListener('click', () => {
        submitBtn.style.display = 'none';
        loading.style.display = 'inline-block';
        statusMsg.innerText = "Processing biometric data... (This may take a moment)";

        // Capture Face Frame
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const context = canvas.getContext('2d');
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        const faceData = canvas.toDataURL('image/jpeg', 0.9);

        if (!audioBase64) {
            alert("Please record audio first");
            submitBtn.style.display = 'inline-block';
            loading.style.display = 'none';
            return;
        }

        // Send to Backend
        fetch("{{ url_for('public.enroll_biometrics') }}", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                face_image: faceData,
                voice_audio: audioBase64
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    statusMsg.innerText = "Registration Complete! Redirecting...";
                    statusMsg.classList.add('text-success');
                    setTimeout(() => {
                        window.location.href = data.redirect;
                    }, 1500);
                } else {
                    statusMsg.innerText = "Error: " + data.message;
                    statusMsg.classList.add('text-danger');
                    submitBtn.style.display = 'inline-block';
                    loading.style.display = 'none';
                }
            })
            .catch(err => {
                statusMsg.innerText = "Server error. Please try again.";
                submitBtn.style.display = 'inline-block';
                loading.style.display = 'none';
            });
    });
</script>
{% endblock %}